build:
  box: python:2.7
  steps:

    # A step that sets up the python virtual environment
    - virtualenv:
        name: setup virtual environment
        install_wheel: false # Enable wheel to speed up builds (experimental)

    # installing necessary requirements
    - pip-install:
        requirements_file: "requirements.txt"
        extra_args: "-rtests/requirements-test.txt"
        packages_list: "wheel"

    # checking python version
    - script:
        name: echo python information
        code: |
          echo "python version $(python --version) running"
          echo "pip version $(pip --version) running"

    # running tests
    - script:
        name: test
        code: |
          tox -e py27

    # making package
    - script:
        name: package_wheel
        code: |
          python setup.py bdist_wheel
          ls -al dist/*whl

    # copy binary to a location that gets passed along to next pipelines
    - script:
        name: copy binary
        code: cp dist/*whl "$WERCKER_OUTPUT_DIR"

# ----- testing wheel ------
# debian - testing

test_debian_testing_py2:
  box: debian:testing

  steps:
    - script:
        name: prerequisites
        code: |
          apt-get update
          apt-get install -qq -y --no-install-recommends python-pip
          python -V
          pip -V

    - script:
        name: package_install
        code: |
          pip install setuptools
          pip install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python -c 'from beprof.profile import Profile'
          echo "all done"

test_debian_testing_py3:
  box: debian:testing

  steps:
    - script:
        name: prerequisites
        code: |
          apt-get update
          apt-get install -qq -y --no-install-recommends python3-pip
          python3 -V
          pip3 -V

    - script:
        name: package_install
        code: |
          pip3 install setuptools
          pip3 install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python3 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python3 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python3 -c 'from beprof.profile import Profile'
          echo "all done"

# debian 8 jessie

test_debian_jessie_py2:
  box: debian:jessie

  steps:
    - script:
        name: prerequisites
        code: |
          apt-get update
          apt-get install -qq -y --no-install-recommends python-pip
          python -V
          pip -V
          easy_install -U pip
          python -m pip -V

    - script:
        name: package_install
        code: |
          python -m pip install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python -c 'from beprof.profile import Profile'
          echo "all done"


test_debian_jessie_py3:
  box: debian:jessie

  steps:
    - script:
        name: prerequisites
        code: |
          apt-get update
          apt-get install -qq -y --no-install-recommends python3-pip
          python3 -V
          pip3 -V
          easy_install3 -U pip
          python3 -m pip -V

    - script:
        name: package_install
        code: |
          python3 -m pip install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python3 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python3 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python3 -c 'from beprof.profile import Profile'
          echo "all done"

# ubuntu 16.04

test_ubuntu_1604_py2:
  box: ubuntu:16.04

  steps:
    - script:
        name: prerequisites
        code: |
          apt-get update
          apt-get install -qq -y --no-install-recommends python-pip
          python -V
          pip -V

    - script:
        name: package_install
        code: |
          pip install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python -c 'from beprof.profile import Profile'
          echo "all done"


test_ubuntu_1604_py3:
  box: ubuntu:16.04

  steps:
    - script:
        name: prerequisites
        code: |
          apt-get update
          apt-get install -qq -y --no-install-recommends python3-pip
          python3 -V
          pip3 -V

    - script:
        name: package_install
        code: |
          pip3 install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python3 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python3 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python3 -c 'from beprof.profile import Profile'
          echo "all done"

# openSUSE

test_opensuse_leap_pip:
  box: opensuse:leap

  steps:
    - script:
        name: prerequisites
        code: |
          zypper ref
          zypper --non-interactive install python python-pip python3-pip
          python2 -V
          python3 -V
          pip2 install --upgrade pip
          pip2 -V
          pip3 install --upgrade pip
          pip3 -V

    - script:
        name: package_install
        code: |
          pip2 install /pipeline/source/beprof-*.whl
          pip3 install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python2 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python2 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python2 -c 'from beprof.profile import Profile'
          echo "all done"

    - script:
        name: test installed package (py3)
        code: |
          echo 'running: python -c "import beprof"'
          python3 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python3 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python3 -c 'from beprof.profile import Profile'
          echo "all done"


test_opensuse_tumbleweed_pip:
  box: opensuse:tumbleweed

  steps:
    - script:
        name: prerequisites
        code: |
          zypper ref
          zypper --non-interactive install python python-pip python3-pip
          python2 -V
          python3 -V
          pip2 install --upgrade pip
          pip2 -V
          pip3 install --upgrade pip
          pip3 -V

    - script:
        name: package_install
        code: |
          pip2 install /pipeline/source/beprof-*.whl
          pip3 install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python2 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python2 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python2 -c 'from beprof.profile import Profile'
          echo "all done"

    - script:
        name: test installed package (py3)
        code: |
          echo 'running: python -c "import beprof"'
          python3 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python3 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python3 -c 'from beprof.profile import Profile'
          echo "all done"

# testing repo install

test_opensuse_leap_repo:
  box: opensuse:leap

  steps:
    - script:
        name: prerequisites
        code: |
          zypper ref
          zypper --non-interactive install python python-pip python3-pip
          python2 -V
          python3 -V
          pip2 install --upgrade pip
          pip2 -V
          pip3 install --upgrade pip
          pip3 -V

    - script:
        name: install numpy from repo
        code: |
          zypper --non-interactive in python-numpy python3-numpy
          echo "---pip2---"
          pip2 freeze
          echo "---pip3---"
          pip3 freeze

    - script:
        name: package_install
        code: |
          pip2 install /pipeline/source/beprof-*.whl
          pip3 install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python2 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python2 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python2 -c 'from beprof.profile import Profile'
          echo "all done"

    - script:
        name: test installed package (py3)
        code: |
          echo 'running: python -c "import beprof"'
          python3 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python3 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python3 -c 'from beprof.profile import Profile'
          echo "all done"


test_opensuse_tumbleweed_repo:
  box: opensuse:tumbleweed

  steps:
    - script:
        name: prerequisites
        code: |
          zypper ref
          zypper --non-interactive install python python-pip python3-pip
          python2 -V
          python3 -V
          pip2 install --upgrade pip
          pip2 -V
          pip3 install --upgrade pip
          pip3 -V

    - script:
        name: install numpy from repo
        code: |
          zypper --non-interactive in python-numpy python3-numpy
          echo "---pip2---"
          pip2 freeze
          echo "---pip3---"
          pip3 freeze

    - script:
        name: package_install
        code: |
          pip2 install /pipeline/source/beprof-*.whl
          pip3 install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python2 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python2 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python2 -c 'from beprof.profile import Profile'
          echo "all done"

    - script:
        name: test installed package (py3)
        code: |
          echo 'running: python -c "import beprof"'
          python3 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python3 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python3 -c 'from beprof.profile import Profile'
          echo "all done"

# Archlinux

test_archlinux_repo:
  box: base/archlinux:latest

  steps:
    - script:
        name: prerequisites
        code: |
          echo "Server = ftp://ftp.icm.edu.pl/pub/Linux/dist/archlinux/core/os/x86_64/" > /etc/pacman.d/mirrorlist
          echo "Server = ftp://ftp.icm.edu.pl/pub/Linux/dist/archlinux/extra/os/x86_64/" >> /etc/pacman.d/mirrorlist
          pacman --noconfirm -Sy archlinux-keyring
          pacman --noconfirm -S python2 python2-pip openssl
          python2 -V
          pip2 -V

    - script:
        name: install numpy from repo
        code: |
          pacman --noconfirm -S python2-numpy
          echo "---pip2---"
          pip2 freeze

    - script:
        name: package_install
        code: |
          pip2 install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python2 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python2 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python2 -c 'from beprof.profile import Profile'
          echo "all done"


test_archlinux_pip:
  box: base/archlinux:latest

  steps:
    - script:
        name: prerequisites
        code: |
          echo "Server = ftp://ftp.icm.edu.pl/pub/Linux/dist/archlinux/core/os/x86_64/" > /etc/pacman.d/mirrorlist
          echo "Server = ftp://ftp.icm.edu.pl/pub/Linux/dist/archlinux/extra/os/x86_64/" >> /etc/pacman.d/mirrorlist
          pacman --noconfirm -Sy archlinux-keyring
          pacman --noconfirm -S python2 python3 python2-pip python3-pip openssl
          python2 -V
          pip2 -V
          python3 -V
          pip3 -V

    - script:
        name: package_install
        code: |
          pip2 install /pipeline/source/beprof-*.whl
          pip3 install /pipeline/source/beprof-*.whl

    # some dummy tests for now
    - script:
        name: test installed package
        code: |
          echo 'running: python -c "import beprof"'
          python2 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python2 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python2 -c 'from beprof.profile import Profile'
          echo "all done"

    - script:
        name: test installed package (py3)
        code: |
          echo 'running: python -c "import beprof"'
          python3 -c 'import beprof'
          echo 'running: python -c "from beprof.curve import Curve"'
          python3 -c 'from beprof.curve import Curve'
          echo 'running: python -c "from beprof.profile import Profile"'
          python3 -c 'from beprof.profile import Profile'
          echo "all done"

# ------- testing on python boxes -------

test-python27:
  box: python:2.7
  steps:
    # installing necessary requirements
    - pip-install:
        requirements_file: "requirements.txt"
        extra_args: "-rtests/requirements-test.txt"
        packages_list: "pytest"

    - script:
        name: echo python information
        code: |
          echo "python version $(python --version) running"
          echo "pip version $(pip --version) running"

    - script:
        name: run pytest
        code: python -m pytest

test-python32:
  box: python:3.2
  steps:
    # installing necessary requirements
    - pip-install:
        requirements_file: "requirements.txt"
        extra_args: "-rtests/requirements-test.txt"
        packages_list: "wheel"

    # checking python version
    - script:
        name: echo python information
        code: |
          echo "python version $(python --version) running"
          echo "pip version $(pip --version) running"

    - script:
        name: run pytest
        code: python -m pytest

test-python33:
  box: python:3.3

  # make a source package in standard python box
  steps:
    # installing necessary requirements
    - pip-install:
        requirements_file: "requirements.txt"
        extra_args: "-rtests/requirements-test.txt"
        packages_list: "wheel"

    # checking python version
    - script:
        name: echo python information
        code: |
          echo "python version $(python --version) running"
          echo "pip version $(pip --version) running"

    - script:
        name: run pytest
        code: python -m pytest

test-python34:
  box: python:3.4
  steps:
    # installing necessary requirements
    - pip-install:
        requirements_file: "requirements.txt"
        extra_args: "-rtests/requirements-test.txt"
        packages_list: "wheel"

    # checking python version
    - script:
        name: echo python information
        code: |
          echo "python version $(python --version) running"
          echo "pip version $(pip --version) running"

    - script:
        name: run pytest
        code: python -m pytest

test-python35:
  box: python:3.5
  steps:
    # installing necessary requirements
    - pip-install:
        requirements_file: "requirements.txt"
        extra_args: "-rtests/requirements-test.txt"
        packages_list: "wheel"

    # checking python version
    - script:
        name: echo python information
        code: |
          echo "python version $(python --version) running"
          echo "pip version $(pip --version) running"

    - script:
        name: run pytest
        code: python -m pytest